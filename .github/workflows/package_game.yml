# This is a basic workflow to help you get started with Actions

name: Package Game and create a new release

# Controls when the action will run. 
on:
  push:
    branches: [ main ]

env:
  UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

jobs:
  createNewReleaseTag:
    runs-on: ubuntu-latest
    outputs:
      previous-tag: ${{ steps.previoustag.outputs.tag }}
      new-tag: ${{ steps.bump-vers.outputs.new_tag }}
    steps:
      - name: 'Get Previous tag'
        id: previoustag
        uses: "WyriHaximus/github-action-get-previous-tag@v1"

      - name: 'Get next minor version'
        id: bump-vers
        uses: "WyriHaximus/github-action-next-semvers@v1"
        with:
          version: ${{ steps.previoustag.outputs.tag }}


  buildForAllSupportedPlatformsAndRelease:
    name: Build for ${{ matrix.targetPlatform }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        targetPlatform:
          - StandaloneWindows64 # Build a Windows 64-bit standalone.
        projectPath:
          - unity-project-with-correct-tests
    
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          lfs: true
          
      - uses: actions/cache@v2
        with:
          path: Library
          key: Library-${{ matrix.targetPlatform }}
          restore-keys: Library-
          
      - uses: game-ci/unity-builder@v2
        with:
          targetPlatform: ${{ matrix.targetPlatform }}
          projectPath: ${{ matrix.projectPath }}
          
      - uses: actions/upload-artifact@v2
        with:
          name: hexxle_game-${{ needs.analyze-tags.outputs.new_tag }}-${{ matrix.targetPlatform }}
          path: build/${{ matrix.targetPlatform }}
      - name: "Download artifacts"
        uses: actions/download-artifact@v2
        with:
          name: "Download game package artifact"
          
      - name: "Display file structure for debugging"
        run: "ls -lah"
      
      - name: "push release tag"
        run: |
          "git tag ${{ needs.analyze-tags.outputs.new_tag }}"
          "git push origin main --tags"
          
      - name: "Create release and push artifact"
        uses: ncipollo/release-action@v1
        with:
          artifacts: hexxle_game-${{ needs.analyze-tags.outputs.new_tag }}-${{ matrix.targetPlatform }}
          token: ${{ secrets.AUTO_RELEASE_TOKEN }}
